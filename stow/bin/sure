#!/usr/bin/env bash
set -e

vars=( HOME SHELL )
for ((i=${#vars[@]}-1; i>=0; i--)); do
  if [[ -z "${!vars[${i}]}" ]]; then
    echo "${vars[${i}]} not set" >&2
    return 1
  fi
done

cmd="env HOME=${HOME}"
if [[ $# -gt 0 ]]; then
  cmd+=" $@"
else
  cmd+=" ${SHELL}"
  # Make bash request a login shell
  if [[ "$(basename "${SHELL}")" = 'bash' ]]; then
    cmd+=" -l"
  fi
fi

sudo -E su root -c "${cmd}"
