"hg6830

loadplugins '\.(js|penta)$'
group user

""""""""""""""
" Preferences
""""""""""""""

" Disable smooth scroll
set! general.smoothScroll=false

" Use blank page for home
set! browser.startup.homepage=about:blank

" Force prompt when quitting
set! browser.showQuitWarning=true

" Use Google for search
set! browser.search.countryCode=US
set! browser.search.defaultenginename=Google
set! browser.search.defaultenginename.US=Google
set! browser.search.isUS=true
set! browser.search.region=US

" Don't close the last window
set! browser.tabs.closeWindowWithLastTab=false

" Disable tab group (Panorama) animation
set! browser.panorama.animate_zoom=false

" Enable "Do Not Track" header
set! privacy.donottrackheader.enabled=true

" Allow Ctrl-C escaping in macOS, and copy/pasting in others
javascript <<EOF
  if (services.runtime.OS == 'Darwin') {
    dactyl.execute('map -modes=n,v,i,t,c -builtin <C-c> <Esc>');
  }
  else {
    dactyl.execute('map -modes=n,v,i,t,c -builtin <C-c> <Pass>');
    dactyl.execute('map -modes=n,v,i,t,c -builtin <C-v> <Pass>');
  }
EOF

" Disable certain keys
javascript <<EOF
  var keys = [
    '<M-S-c>', // focusChatBar
    '<M-[>', // goBackKb
    '<M-Left>', // goBackKb
    '<BS>', // goBackKb
    '<M-]>', // goFowardKb
    '<M-Right>', // goFowardKb
    '<S-BS>', // goFowardKb
    '<M-f>', // Find
    '<M-g>', // Find Again
    '<F3>', // Find Again
    '<M-k>', // Key Search
  ];

  keys.forEach(function(key) {
    dactyl.execute('nmap -builtin ' + key + ' <Nop>');
  });
EOF

" Force the status line to display when toggling fullscreen.
au Fullscreen .* :set guioptions+=s

" Set up fixed width fonts
javascript <<EOF
  var selectors,
      styles;

  selectors = {
    'font-family': ['FontCode', 'FontFixed', 'Hint'],
    'font-size': ['FontFixed', 'Hint'],
    'font-weight': ['FontCode', 'FontFixed', 'Hint'],
  };

  styles = false;

  switch (services.runtime.OS) {
    case 'Darwin':
      styles = {
        'font-family': 'Menlo',
        'font-size': '13px',
        'font-weight': 'normal',
      };
      break;
    case 'Linux':
      styles = {
        'font-family': 'Ubuntu Mono',
        'font-size': '13px',
      };
      break;
  }

  Object.getOwnPropertyNames(selectors).forEach(function(prop) {
    var css;

    if (styles.hasOwnProperty(prop)) {
      css = prop + ':' + styles[prop] + ' !important';

      selectors[prop].forEach(function(name) {
        dactyl.execute('highlight -append ' + name + ' ' + css);
      });
    }
  });
EOF

" Disable pentadactyl on specific Google Docs types
" TODO: Documents: Likes to capture the Document title input instead of the document itself.
" TODO: Spreadsheets: Lots of error message in commandline, probably because the first input returns null
autocmd PageLoadPre ^https?://docs.google.com/(document|presentation|spreadsheets)/.*/edit :normal! <C-z>
autocmd LocationChange ^https?://docs.google.com/(document|presentation|spreadsheets)/.*/edit :normal! gi


"""""""""""
" Commands
"""""""""""

" Flush browser DNS
command flushdns set! network.dnsCacheExpiration=0 | set! network.dnsCacheExpiration&

" Enable Reader mode and create command
set! reader.parse-on-load.enabled=true
command reader execute "open about:reader?url=" + content.location.href

" Tab Group commands

" Create new tab group
" TODO: Test that group doesn't already exist, even though FF allows it
command tgnew
  \ -nargs=+
  \ -description "Create a new tab group"
  \ -js <<EOT
  tabs.getGroups(function({GroupItems}) {
    GroupItems.newGroup().setTitle(args);
  });
EOT

" Delete tab group
command tgdel
  \ -nargs=+
  \ -description "Delete a tab group"
  \ -js <<EOT
  tabs.getGroups(function({GroupItems}) {
    for (item of GroupItems.groupItems) {
      if (item.id == args) {
        item.closeAll();
      }
    }
  });
EOT

" List tab groups
command tgls
  \ -nargs=0
  \ -description "List tab groups"
  \ -js <<EOT
  tabs.getGroups(function({GroupItems}) {
    let items = [];

    for (item of GroupItems.groupItems) {
      let title = item.getTitle();
      items.push(item.id + (title ? ': ' + title : ''));
    }
    dactyl.echomsg(items.join("\n"));
  });
EOT

" TODO tabgroup rename

""""""""""
" Add-ons
""""""""""

" Force uBlock to use legacy interface
set! extensions.ublock0.forceLegacyToolbarButton=true

" Load local pentadactyl configuration
source! $HOME/.pentadactylrc.local
